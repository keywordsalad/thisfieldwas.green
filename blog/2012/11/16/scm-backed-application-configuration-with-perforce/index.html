<!doctype html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>

<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>This Field Was Green - SCM-Backed Application Configuration with Perforce</title>
<link rel="canonical" href="https://thisfieldwas.green/blog/2012/11/16/scm-backed-application-configuration-with-perforce">
<link rel="shortcut icon" sizes="16x16 32x32 48x48 64x64 96x96 128x128 256x256" href="https://thisfieldwas.green/favicon.ico">

<meta property="og:site_name" content="">
<meta property="og:title" content="SCM-Backed Application Configuration with Perforce">
<meta property="og:url" content="https://thisfieldwas.green/blog/2012/11/16/scm-backed-application-configuration-with-perforce">
<meta property="og:description" content="">
<meta property="og:image:url" content="https://thisfieldwas.green/images/grass-256x256.png">

<meta property="article:published_time" content="2012-11-16T17:00:00-06:00">
  <meta property="article:modified_time" content="2012-11-16T17:00:00-06:00">
  <meta property="article:author" content="Logan McGrath">
  <meta property="article:tag" content="configuration management">
  <meta property="article:tag" content="Perforce">
  <meta property="article:tag" content="Sinatra">
  <meta property="article:tag" content="AngularJS">
  
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@thisgreenfield">
<meta name="twitter:title" content="SCM-Backed Application Configuration with Perforce">



<link rel="stylesheet" href="/css/main.css">
<script src="/js/main.js"></script>

</head>
<body class="post post-full">

<header class="page-header">
  <div class="content-bound">
    <div class="logo-icon"><a href="/"></a></div>
    <div class="logo-nav">
      <h1 class="logo"><a href="/">This Field Was Green</a></h1>
      <nav class="main-nav">
  <a href="/">Home</a>
  <a href="/blog">Blog</a>
  <a href="/resume">Resume</a>
  <a href="/contact">Contact</a>
</nav>

    </div>
  </div>
</header>

<main class="page-content">
  <div class="content-bound">
    <h1 class="post-title">
  <a href="/blog/2012/11/16/scm-backed-application-configuration-with-perforce">SCM-Backed Application Configuration with Perforce</a>
</h1>
<div class="post-meta">
  <p class="post-published">
    Posted on November 16, 2012
    by Logan McGrath
    </p>
  <p class="post-tags">
      Tags: <a class="tag" href="/tags/configuration-management">configuration management</a>, <a class="tag" href="/tags/perforce">Perforce</a>, <a class="tag" href="/tags/sinatra">Sinatra</a>, <a class="tag" href="/tags/angular-js">AngularJS</a>
    </p>
  </div>
<p>Continuing from my <a href="/blog/2012/11/07/using-perforce-chronicle-for-application-configuration">last post</a>, I’ve <a href="https://github.com/lmcgrath/App-Config-App/">forked</a> Paul Hammant’s original App-Config-App and modified it to work against Perforce. I’ve decided not to continue using Perforce Chronicle as it is primarily intended for content management.</p>
<!--more-->
<p>With this version, App-Config-App is written in Ruby, mostly using <a href="http://www.sinatrarb.com/">Sinatra</a>, a lightweight web application framework. I’m still using <a href="http://angularjs.org/">AngularJS</a>, but I’ve also added a few other things:</p>
<ul>
<li>A .rvmrc file, so you automagically switch to Ruby 1.9.3</li>
<li>A Gemfile, so you don’t have to install everything individually :)</li>
<li><a href="https://github.com/sinatra/sinatra-contrib">Sinatra-Contrib</a> for view templating support</li>
<li><a href="http://nakajima.github.com/rack-flash/">Rack Flash</a> for flash messages</li>
<li><a href="http://highline.rubyforge.org/">HighLine</a> for masking passwords</li>
<li><a href="http://rubygems.org/gems/json">json</a> to manipulate JSON in native Ruby</li>
</ul>
<h2 id="getting-it-to-work.">Getting it to work.</h2>
<p>App-Config-App requires a couple things to work:</p>
<ul>
<li>Ruby 1.9.3 and Bundler</li>
<li>p4 - the Perforce command line client</li>
<li>p4d - the Perforce server</li>
</ul>
<p>All installation and example setup details may be found in <a href="https://github.com/lmcgrath/app-config-app/blob/master/README.md">App-Config-App’s README</a>.</p>
<h2 id="using-app-config-app">Using App-Config-App</h2>
<p>When you login, you should see this screen:</p>
<figure id="img-app-start-aside" class="image">
  <p class="content">
    <a href="/images/app-config2/start.png" class="image-link">
      <img src="/images/app-config2/start.png"
        id="img-app-start"
        
        >
    </a>
  </p>
  
</figure>
<p>You’ll notice I made the extra effort to add colors and drop shadows :D The application works from the project root in Perforce, so the files in each branch are viewable here. Clicking on “Dev” &gt; “aardvark_configuration.html” will bring up a form for editing <code>aardvark_configuration.json</code> as in the previous version:</p>
<figure id="img-app-config-aside" class="image">
  <p class="content">
    <a href="/images/app-config2/aardvark_configuration.png" class="image-link">
      <img src="/images/app-config2/aardvark_configuration.png"
        id="img-app-config"
        
        >
    </a>
  </p>
  
</figure>
<p>Changes to the form data are automatically saved. After making a view edits, you can click “View Diff” to get the diffs or “Revert” your changes. Go ahead and change the email address and fiddle around with the banned nicks, then go click “Pending Changes”:</p>
<figure id="img-app-changes-aside" class="image">
  <p class="content">
    <a href="/images/app-config2/changes.png" class="image-link">
      <img src="/images/app-config2/changes.png"
        id="img-app-changes"
        
        >
    </a>
  </p>
  
</figure>
<p>This screen shows all files that were changed and their diffs as well. You can “Revert” each file individually, and if you want to commit all changes, then enter a commit message and click “Commit Changes”. If you commit the changes and go back to “Dev” &gt; “aardvark_configuration.html”, you’ll see the new values in the form:</p>
<figure id="image-app-commit-aside" class="image">
  <p class="content">
    <a href="/images/app-config2/aardvark_configuration-changed.png" class="image-link">
      <img src="/images/app-config2/aardvark_configuration-changed.png"
        id="image-app-commit"
        
        >
    </a>
  </p>
  
</figure>
<h2 id="security-and-permissions">Security and Permissions</h2>
<p>Permissions and security are managed through Perforce. For users to be able to login, they must have a user and client configured in Perforce. Those users must also have permissions configured in order to view or modify files.</p>
<p>The <code>setup_example.rb</code> script creates three test users to demonstrate branch permissions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Username        Password   Write     Read</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>sally-runtime   bananas    prod      staging, dev</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>jimmy-qa        apples     staging   dev</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>joe-developer   oranges    dev</span></code></pre></div>
<p>Logging in as any of these users will hide branches that don’t have at least read-level access, and branches that don’t have write-level access won’t allow changes.</p>
<p><strong>All users created by <code>setup_example.rb</code> are intended only as examples.</strong> In the real world, all application users should be setup with real logins and real permissions.</p>
<p>It is this support for users and per-branch permissions that I am using Perforce as the SCM backend rather than Git.</p>
<h3 id="application-users">Application Users</h3>
<p>The <code>setup_example.rb</code> script also sets up three application users to demonstrate how an application would consume configuration:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Username   Password   Read</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>-----------------------------</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dev-app    s3cret1    dev</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>qa-app     s3cret2    staging</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>prod-app   s3cret3    prod</span></code></pre></div>
<p>In theory, an application would periodically poll <a href="http://localhost:9292/dev/aardvark_configuration.md5">aardvark_configuration.md5</a> until the hash value changed, then load <a href="http://localhost:9292/dev/aardvark_configuration.json">aardvark_configuration.json</a> and reconfigure itself.</p>
<p>Application user accounts are configured in Perforce like any other user. I highly recommend that application users be given ready-only access to individual files rather than entire branches.</p>
<h2 id="divergence">Divergence</h2>
<p>Right now, App-Config-App offers no UI tools for managing divergence and merging. Merges must be performed outside App-Config-App, and the specific safety nets to prevent nefarious change vulnerabilities are dependent on your branch specs and permissions configuration.</p>
<p>There are also are no tools to manage conflicts of existing edits with incoming changes from another user. If a Perforce sync fails due to a conflict, you are best to revert all changes and enter them again.</p>
<h2 id="todo"><span class="citation" data-cites="TODO">@TODO</span></h2>
<h3 id="a-better-model-for-autosave">A better model for autosave</h3>
<p>Autosave in AngularJS isn’t very good. AngularJS doesn’t integrate with DOM events the way idiomatic JavaScript does, or provide a reasonable abstraction the way Dojo Toolkit or JQuery do. Right now, autosave in App-Config-App triggers with every key press in the config forms, and pummels the back-end server with ajax posts.</p>
<p>I’ve also noticed that the autosave triggers even when a value is invalid. The first time an email address, for example, becomes invalid, AngularJS will post back the JSON, but without the invalid email address field–the invalid field is entirely left out of the JSON structure. After that, AngularJS will stop autosaving until the value is valid. There are also no measures in place to prevent a user from leaving an invalid value and saving an incomplete JSON file.</p>
<h3 id="a-better-model-for-validation">A better model for validation</h3>
<p>AngularJS does not offer a good validation API. The validation API is quite opaque and I haven’t found any real examples using it. The built-in form validation is inadequate. There are few ng-* HTML attributes exposing more than basic configuration parameters, and no hooks offered as extension points.</p>
<p>For example, I’m using <a href="http://docs.angularjs.org/api/ng.directive:input.text">regular expressions</a> for date validation in App-Config-App. There isn’t a hook to provide custom validation checks, and regular expressions don’t perform sanity checks. Values such as “00/00/0000” will pass validation.</p>
<h3 id="more-example-clients-than-the-java-one-needed">More example clients than the Java one needed</h3>
<p>The <a href="https://github.com/lmcgrath/app-config-java">App-Config-Java</a> client is enough to show the basic idea behind caching and reloading configuration from App-Config-App. I would like to create a few more examples in a couple different platforms, possibly also showcasing “<a href="http://paulhammant.com/2012/07/10/app-config-workflow-using-scm/">hot reconfiguration</a>” for feature toggles.</p>
<h3 id="someone-should-port-this-to-subversion-or-tfs">Someone should port this to Subversion or TFS</h3>
<p>App-Config-App should be usable by the largest possible audience. For instance, if you’re using Subversion, then you should be able to take advantage of the existing infrastructure.</p>
<p>The reason I point out Subversion and TFS is largely due to support of per-branch permissions.</p>

  </div>
</main>

<footer class="page-footer">
  <div class="content-bound">
    <nav class="main-nav">
  <a href="/">Home</a>
  <a href="/blog">Blog</a>
  <a href="/resume">Resume</a>
  <a href="/contact">Contact</a>
</nav>

    <p class="copyright">Copyright &copy; <span class="copyright-date">2012</span> Logan McGrath. All rights reserved.</p>
    <ul class="acks">
      <li>Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.</li>
      <li><a href="https://www.flaticon.com/free-icon/grass_2790190">Icon</a> made by <a href="https://www.flaticon.com/authors/good-ware">Good Ware</a> from <a href="https://www.flaticon.com/">Flaticon</a>.</li>
    </ul>
    <p class="generated">This page was rendered from <a href="https://bitsof.thisfieldwas.green/keywordsalad/thisfieldwas.green/src/commit/a96d7a9/site/_posts/2012-11-16-scm-backed-application-configuration-with-perforce.md">2012-11-16-scm-backed-application-configuration-with-perforce.md</a> at commit <a class="commit-link" href="https://bitsof.thisfieldwas.green/keywordsalad/thisfieldwas.green/src/commit/a96d7a9">a96d7a9</a>.</p>
    </div>
  </div>
</footer>

</body>
</html>
